{% extends 'silk/base/root_base.html' %}
{% load inclusion %}
{% block menu %}
    {% root_menu request %}
{% endblock %}

{% block style %}
    {{ block.super }}
    <style>
        .wrapper {
            width: 100%;
            margin-bottom: 20px;
        }

        .inner {
            margin: auto;
            width: 960px;
        }

        .summary-cell {
            display: inline-block;
            text-align: center;
            padding: 10px;
            margin-left: 10px;
            margin-top: 10px;
        }

        .summary-cell .desc {
            margin-top: 8px;
            font-size: 12px;
        }

        .no-data {
            font-size: 12px;
            font-style: oblique;
            margin-left: 10px;
        }

        h2 {
            margin-bottom: 0;;
        }

        .resizing-input {
            display: inline-block;
        }

        .resizing-input input, .resizing-input span {
            font-size: 12px;
            font-family: Sans-serif;
            white-space: pre;
            padding: 5px;
        }

        .resizing-input input:focus {
            outline: none;
        }

        #filters {
            font-style: oblique;
            font-size: 12px;
        }

        #filters a {
            text-decoration: underline;
        }
    </style>
{% endblock %}

{% block js %}
    {{ block.super }}
    <script>
        $(document).ready(function () {
            var $inputs = $('.resizing-input');

            function resizeForText(text) {
                var $this = $(this);
                if (!text.trim()) {
                    text = $this.attr('placeholder').trim();
                }
                var $span = $this.parent().find('span');
                $span.text(text);
                var $inputSize = $span.width();
                $this.css("width", $inputSize);
            }

            $inputs.find('input').keypress(function (e) {
                if (e.which && e.charCode) {
                    var c = String.fromCharCode(e.keyCode | e.charCode);
                    var $this = $(this);
                    resizeForText.call($this, $this.val() + c);
                }
            });

            $inputs.find('input').keyup(function (e) { // Backspace event only fires for keyup
                if (e.keyCode === 8 || e.keyCode === 46) {
                    resizeForText.call($(this), $(this).val());
                }
            });

            $inputs.find('input').each(function () {
                var $this = $(this);
                resizeForText.call($this, $this.val())
            });

            $inputs.focusout(function () {
                $('#filter-form').submit();
            });

            $('.datetimepicker').datetimepicker({
                step: 10,
                onChangeDateTime: function (dp, $input) {
                    resizeForText.call($input, $input.val())
                }
            });

            console.log()
        });

    </script>
{% endblock %}
{% block data %}
    <div class="wrapper">
        <div class="inner">
            <div id="filters">
                <form action="." name="filter-form" id="filter-form" method="post">
                    {% csrf_token %}
                </form>
                <div class="resizing-input">
                    Using requests that executed
                    <input form="filter-form"
                           class="typ"
                           type="hidden"
                           value="SecondsFilter"
                           name="filter-seconds-typ">
                    <input type="text"
                           placeholder="seconds"
                           form="filter-form"
                           name="filter-seconds-value"
                           value="{{ filters.seconds.value }}"
                            >
                    seconds ago,
                    <span style="display:none"></span>
                </div>
                <div class="resizing-input">
                    before
                    <input form="filter-form"
                           class="typ"
                           type="hidden"
                           value="BeforeDateFilter"
                           name="filter-beforedate-typ">
                    <input class="datetimepicker"
                           type="text"
                           placeholder="date"
                           form="filter-form"
                           name="filter-beforedate-value"
                            value="{{ filters.beforedate.value }}"
                            />,
                    <span style="display:none"></span>
                </div>
                <div class="resizing-input">
                    and after
                    <input form="filter-form"
                           class="typ"
                           type="hidden"
                           value="AfterDateFilter"
                           name="filter-afterdate-typ">
                    <input class="datetimepicker"
                           type="text"
                           placeholder="date"
                           form="filter-form"
                           name="filter-afterdate-value"
                           value="{{ filters.afterdate.value }}"
                            >.
                    <span style="display:none"></span>
                </div>
            </div>
            <h2>Summary</h2>
            {% if num_requests %}
                <div class="summary-cell">
                    <div class="num"><span class="numeric">{{ num_requests }}</span></div>
                    <div class="desc">Requests</div>
                </div>
                <div class="summary-cell">
                    <div class="num"><span class="numeric">{{ num_profiles }}</span></div>
                    <div class="desc">Profiles</div>
                </div>
                <div class="summary-cell">
                    <div class="num"><span class="numeric">{{ avg_overall_time | floatformat:0 }}<span class="unit">ms</span></span></div>
                    <div class="desc">Avg. Time</div>
                </div>
                <div class="summary-cell">
                    <div class="num"><span class="numeric">{{ avg_num_queries | floatformat:2 }}</span></div>
                    <div class="desc">Avg. #Queries</div>
                </div>
                <div class="summary-cell">
                    <div class="num"><span class="numeric">{{ avg_time_spent_on_queries |floatformat:0 }}<span class="unit">ms</span></span></div>
                    <div class="desc">Avg. DB Time</div>
                </div>
            {% else %}
                <p class="no-data">No data</p>
            {% endif %}
            <h2>Most Time Overall</h2>
            {% if longest_queries_by_view %}
                {% for x in longest_queries_by_view %}
                    {% request_summary x %}
                {% endfor %}
            {% else %}
                <p class="no-data">No data</p>
            {% endif %}
            <h2>Most Time Spent in Database</h2>
            {% if most_time_spent_in_db %}
                {% for x in most_time_spent_in_db %}
                    {% request_summary x %}
                {% endfor %}
            {% else %}
                <p class="no-data">No data</p>
            {% endif %}
            <h2>Most Database Queries</h2>
            {% if most_queries %}
                {% for x in most_queries %}
                    {% request_summary x %}
                {% endfor %}
            {% else %}
                <p class="no-data">No data</p>
            {% endif %}
        </div>
    </div>

{% endblock %}

{# Hide filter hamburger menu #}
{% block top %}{% endblock %}
{% block filter %}{% endblock %}